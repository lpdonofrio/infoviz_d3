<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <!--
    References
    https://syntagmatic.github.io/parallel-coordinates/
    http://bl.ocks.org/eesur/1a2514440351ec22f176
    http://bl.ocks.org/syntagmatic/3687826
    http://bl.ocks.org/tpreusse/2bc99d74a461b8c0acb1 -->

    <title>Lucia and Yiyi take D3</title>

    <!-- styling css -->
    <!-- <link rel="stylesheet" href="https://rawgit.com/tpreusse/radar-chart-d3/master/src/radar-chart.css"> -->
    <link rel="stylesheet" href="radar-chart.css">
    <link rel="stylesheet" type="text/css" href="https://syntagmatic.github.io/parallel-coordinates/d3.parcoords.css">
    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="stylesheet" href="http://fonts.googleapis.com/icon?family=Material+Icons" >
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.1/css/materialize.min.css">

    <!-- let browser know website is optimized for mobile -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <!-- external charting and styling library javascript -->
    <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.1/js/materialize.min.js"></script>
    <script src="http://d3js.org/d3.v3.js"></script>
    <script src="divgrid.js"></script>
    <script src="radar-chart.js"></script>
    <!-- <script src="https://rawgit.com/tpreusse/radar-chart-d3/master/src/radar-chart.js"></script> -->
    <script src="https://syntagmatic.github.io/parallel-coordinates/d3.parcoords.js"></script>
</head>

<body>
    <!-- ==================================================== -->
    <!-- ================== HTML ELEMENTS =================== -->
    <!-- ==================================================== -->


    <!-- buttons -->
    <nav>
        <div class="nav-wrapper">
            <a href="#!" class="brand-logo title">Top 50 World Universities</a>
            <ul class="right hide-on-med-and-down">
                <li><a class="waves-effect waves-light" onclick="displayChart(2011)">2011</a></li>
                <li><a class="waves-effect waves-light" onclick="displayChart(2012)">2012</a></li>
                <li><a class="waves-effect waves-light" onclick="displayChart(2013)">2013</a></li>
                <li><a class="waves-effect waves-light" onclick="displayChart(2014)">2014</a></li>
                <li><a class="waves-effect waves-light" onclick="displayChart(2015)">2015</a></li>
                <li><a class="waves-effect waves-light" onclick="displayChart(2016)">2016</a></li>
            </ul>
        </div>
    </nav>

    <!-- text prompt -->
    <div class="row">
        <div class="col s12">
            <p id="chartprompt">
                Click one of the years in the top navigation bar to see data for that year
            </p>
        </div>
        <div class="col s8">
            <div id="parallelcoords" class="parcoords">
            </div>
        </div>
        <div class="col s4">
            <div id="radarchart">
            </div>
        </div>
        <div class="col s4 m3">
          <div id = "box" class="card blue-grey darken-1">
            <div class="card-content white-text">
              <span class="card-title">Legend</span>
              <p>Teaching score: the learning environment; <br />
                International score: international outlook; <br />
                Research score: volume, income, reputation; <br />
                Citations score: research influence; <br />
                Income score: industry knowledge transfer; <br />
                Staff to Student score: staff to student ratio; <br />
                Num Students: total number of students. </p>
            </div>
          </div>
        </div>
        <div class="col s12">
            <div id="datatable">
            </div>
        </div>
    </div>
    <!-- charts and table -->



    <!-- <table id="datatable" class="highlight"></table> -->

    <!-- ==================================================== -->
    <!-- ==================== JAVASCRIPT ==================== -->
    <!-- ==================================================== -->
    <script  type="text/javascript">

    $("#box").hide();

    // when a user clicks on the corresponding button
    // displayChart shows the chart of a specified year
    function displayChart(year) {
        document.getElementById("chartprompt").innerHTML =
        "Select a range of values by clicking and dragging on the axes of the parallel coordinates"
        + "<br />" + "Hover over the table to highlight any specific university";


        // highlight the button for the selected year
        var buttons = document.getElementsByTagName('li'), names = [];
        for (var i = 0, j = buttons.length; i<j; i++) {
            button_year = buttons[i].getElementsByTagName('a')[0].text;
            buttons[i].className = (button_year == year)? "active":"";
        };

        $("#box").show();

        renderChart('timesData' + year + '.csv');
    }

    // renderChart reads in data from file_name and render the
    // parallel coordinates and radar chart
    function renderChart(file_name){

        // --------------- RADAR CHART ---------------
        // radar chart initializations
        var chart = RadarChart.chart();
        var cfg = chart.config(); // retrieve default config
        chart.config({
            w: cfg.w / 1.9,
            h: cfg.h / 1.9,
            levels: 5,
            circles: false,
            maxValue: 100,
            minValue: 0
        });

        d3.select("#radarchart").select("svg").remove();
        var chart_radar = d3.select('#radarchart').append('svg')
        .attr('width', cfg.w)
        .attr('height', cfg.h)
        .append('g')
        .classed('single', 1);

        // --------------- read data and charts update ---------------
        d3.csv(file_name, function(data) {

            // var dimensions = {
            //                 'World Rank': {
            //                     tickValues: [0, 50]
            //                 }
            //                 'Country': {
            //                     tickValues: ['USA', 'South Korea']
            //                 }
            //                 'Teaching': {
            //                     tickValues: [0, 100]
            //                 }
            //                 'International': {
            //                     tickValues: [0, 100]
            //                 }
            //                 'Research': {
            //                     tickValues: [0,100]
            //                 }
            //                 'Citations': {
            //                     tickValues: [0, 100]
            //                 }
            //                 'Income': {
            //                     tickValues: [0, 100]
            //                 }
            //                 'Staff to Student': {
            //                     tickValues: [0, 100]
            //                 }
            //                 'Num Students': {
            //                     tickValues: [0, 80000]
            //                 }};

            // PARALLEL COORDINATES
            // parallel coordinates initializations & data binding
            d3.select("#parallelcoords").select("svg").remove();
            var parcoords = d3.parcoords()("#parallelcoords")
            .data(data)
            .hideAxis(["University"])
            .margin({ top: 30, left: 10, bottom: 10, right: 10})
            .composite("darken")
            .alpha(0.35)
            // .dimensions(dimensions)
            .render()      
            .brushMode("1D-axes");  // enable brushing
            


            parcoords.svg.selectAll("text").style("font", "10px sans-serif");
            chart_radar.datum(radarChartFormat(data)).call(chart);


            // --------------- charts & table data linking ---------------
            // highlight datapoint in charts based on mouseover in the table

            // TEXT TABLE
            var datatable = d3.divgrid();

            // highlight datapoint in charts based on mouseover in the table
            // initial loading
            d3.select("#datatable")
            .datum(data)
            .call(datatable)
            .selectAll(".row")
            .on({
                "mouseover": function(d) {
                    parcoords.highlight([d]);
                    parcoords.color('orange');
                    chart_radar.datum(radarChartFormat(d)).call(chart);
                    // chart.color('orange'); [I AM THINKING IT SHOULD BE SOMETHING LIKE THIS??]
                },
                "mouseout": function(){
                    parcoords.unhighlight();
                }
            });

            // highlight datapoint in charts based on mouseover in the table
            // brushing
            parcoords.brushedColor("orange");
            parcoords.on("brush", function(selected_data) {
                // parcoords.alpha(2);	[I THOUGHT THIS WOULD MAKE THE LINES THICKER BUT IT IS NOT...]
                parcoords.color('orange');
                parcoords.alphaOnBrushed(0.3);
                d3.select("#datatable")
                .datum(selected_data)
                .call(datatable)
                .selectAll(".row")
                .on({
                    "mouseover": function(d) {
                        parcoords.highlight([d]);
                        parcoords.color('orange');
                        chart_radar.datum(radarChartFormat(d)).call(chart);
                        // chart.color('orange'); [I AM THINKING IT SHOULD BE SOMETHING LIKE THIS??]
                    },
                    "mouseout": function(){
                        parcoords.unhighlight();
                        chart_radar.datum(radarChartFormat(selected_data)).call(chart);
                    }
                });
                chart_radar.datum(radarChartFormat(selected_data)).call(chart);
            });

/////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////
//          TRYING TOOLTIP CODE
//          Source: https://gist.github.com/mostaphaRoudsari/b4e090bb50146d88aec4
///////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////
            // parcoords.on("mousemove", function() {
            //         var mousePosition = d3.mouse(this);             
            //         highlightLineOnClick(mousePosition, true); //true will also add tooltip
            //         })
            //         .on("mouseout", function(){
            //             cleanTooltip();
            //             parcoords.unhighlight();
            //         });
            
            // function cleanTooltip(){
            //     // removes any object under #tooltip is
            //     parcoords.svg.selectAll("#tooltip")
            //         .remove();
            // }
            
            // function addTooltip(clicked, clickedCenPts){
                
            //     // add tooltip to multiple clicked lines
            //     var clickedDataSet = [];
            //     var margins = parcoords.margin()
            //     // get all the values into a single list
            //     // I'm pretty sure there is a better way to write this is Javascript
            //     for (var i=0; i<clicked.length; i++){
            //         for (var j=0; j<clickedCenPts[i].length; j++){
            //             var text = d3.values(clicked[i])[j];
            //             // not clean at all!
            //             var x = clickedCenPts[i][j][0] - margins.left;
            //             var y = clickedCenPts[i][j][1] - margins.top;
            //             clickedDataSet.push([x, y, text]);
            //         }
            //     };
            //     // add rectangles
            //     var fontSize = 14;
            //     var padding = 2;
            //     var rectHeight = fontSize + 2 * padding; //based on font size
            //     parcoords.svg.selectAll("rect[id='tooltip']")
            //             .data(clickedDataSet).enter()
            //             .append("rect")
            //             .attr("x", function(d) { return d[0] - d[2].length * 5;})
            //             .attr("y", function(d) { return d[1] - rectHeight + 2 * padding; })
            //             .attr("rx", "2")
            //             .attr("ry", "2")
            //             .attr("id", "tooltip")
            //             .attr("fill", "grey")
            //             .attr("opacity", 0.9)
            //             .attr("width", function(d){return d[2].length * 10;})
            //             .attr("height", rectHeight);
            //     // add text on top of rectangle
            //     parcoords.svg.selectAll("text[id='tooltip']")
            //         .data(clickedDataSet).enter()
            //             .append("text")
            //             .attr("x", function(d) { return d[0];})
            //             .attr("y", function(d) { return d[1]; })
            //             .attr("id", "tooltip")
            //             .attr("fill", "white")
            //             .attr("text-anchor", "middle")
            //             .attr("font-size", fontSize)
            //             .text( function (d){ return d[2];})    
            // }
        });
    }

    // --------------- radar chart data transformation ---------------
    // reformat the data from selected row/brush
    // area to be displayed on radar chart

    var radarChartAxes = ["Teaching", "International", "Research",
    "Citations", "Income", "Staff Student Score"];

    // given data in the original format,
    // return reformatted data for radar chart
    function radarChartFormat(data){
        // TODO: need to handle empty selection!
        var result = [];
        if (data.constructor === Array){
            data.forEach(function(item){
                result.push(formatOneRadar(item));
            });
        }else{
            result.push(formatOneRadar(data));
        }
        return result;
    }

    // helper function to reformat one datapoint to radar chart format
    function formatOneRadar(item){
        var axesVal = [], key;
        for (key in item) {
            if (key != "University" && radarChartAxes.indexOf(key) >= 0){
                axesVal.push({axis: key, value: Number(item[key])});
            }
        };
        var reformatted = {className: item["University"], axes: axesVal};
        return reformatted;
    }
    </script>

</body>
</html>
